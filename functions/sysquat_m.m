function [sys] = sysquat_m(omega, q, varQ, varR, g, tau, T)
q0 = q(1);
q1 = q(2);
q2 = q(3);
q3 = q(4);

r = rot(q);

Omega = Omegacalc(omega);
Psi = Psicalc(q);

F = [0.5*Omega, -0.5*Psi;
    zeros(3,4)          , -diag(1./tau)];

Phi = eye(7) + F*T;


omegap = sqrt(omega(1)^2 + omega(2)^2 + omega(3)^2);
Phi(1:4,1:4) = (eye(4)*cos(1/2*omegap*T) + Omega*inv(omegap)*sin(1/2*omegap*T));

G = [-0.5*Psi,  zeros(4,3);
          zeros(3,3),    eye(3,3)];

H = [eye(4), zeros(4,3)];
H(5,1) = (2*q3*r(1,1) - 2*q0*r(1,2))/(r(1,1)^2);
H(5,2) = (2*q2*r(1,1) - 2*q1*r(1,2))/(r(1,1)^2);
H(5,3) = (2*q1*r(1,1) + 2*q2*r(1,2))/(r(1,1)^2);
H(5,4) = (2*q0*r(1,1) + 2*q3*r(1,2))/(r(1,1)^2);
H(5,5:7) = zeros(1,3);    
      
E = diag(varQ);
         
Q = G*E*G'*T;

R = diag(varR);


Ef = 0.01*[ 1.4803399819097904e-005 0.0014590105834444845 0.0017107285399275364 0.0020022809722185539 0.00099777056214160197 0.0010263839752163097 0.028261295273978856 ; 
0.0014590105834444845 1.4803399819097904e-005 0.0020022809722185539 0.0017107285399275364 0.026246343289360544 0.028261295273978856 0.0010263839752163097 ; 
0.0017107285399275364 0.0020022809722185539 1.4803399819097904e-005 0.0014590105834444845 0.028261295273978856 0.026246343289360544 0.00099777056214160197 ; 
0.0020022809722185539 0.0017107285399275364 0.0014590105834444845 1.4803399819097904e-005 0.0010263839752163097 0.00099777056214160197 0.026246343289360544 ; 
0 0 0 0 1.6787360226480613e-009 0 0 ; 
0 0 0 0 0 1.9745792003171669e-009 0 ; 
0 0 0 0 0 0 4.3422240198188913e-009 ]; 

Eg = 0.001*[ 0.0042620984684868758 0.0043488658300001575 0.12045557728903865 0 0 0 ; 
0.11402512126384462 0.12045557728903865 0.0043488658300001575 0 0 0 ; 
0.12045557728903865 0.11402512126384462 0.0042620984684868758 0 0 0 ; 
0.0043488658300001575 0.0042620984684868758 0.11402512126384462 0 0 0 ; 
0 0 0 0 0 0 ; 
0 0 0 0 0 0 ; 
0 0 0 0 0 0 ]; 

Eh = 0.01*[ 9.4416920243637286 172.71773757701732 179.67905596416497 8.6243952278318989 0 0 0 ; 
8.6243952278318989 179.67905596416497 1072.71773757701732 9.4416920243637286 0 0 0 ; 
179.67905596416497 8.6243952278318989 9.4416920243637286 172.71773757701732 0 0 0 ; 
2.0736036134272466 0.10522561984381455 0.12891363679983572 2.0735239135853307 0 0 0 ];

M = [ 1 0 0 0 0 0 0 ; 
0 1 0 0 0 0 0 ; 
0 0 1 0 0 0 0 ; 
0 0 0 1 0 0 0 ; 
0 0 0 0 1 0 0 ; 
0 0 0 0 0 1 0 ; 
0 0 0 0 0 0 1 ]; 

Mf = M;
Mh = eye(4);
% a = -1;
% b = 1;
% delta  = a + (b-a).*rand;
% deltaPhi = M*delta*Ef;
% deltaG = M*delta*Eg;
% 
% Phi = Phi + deltaPhi;
% G = G + deltaG;

sys.Phi = Phi;
sys.G = G;
sys.H = H;
sys.Q = Q;
sys.Qeta = E;
sys.R = R;

sys.alfa = 2000; % Sayed
% sys.alfa = 0.1;
% sys.alfa = 1000;
sys.Ef = Ef;
sys.Eg = Eg;
sys.Eh = Eh;
sys.M = M;
sys.Mf = Mf;
sys.Mh = Mh;

sys.gamma = 100000;